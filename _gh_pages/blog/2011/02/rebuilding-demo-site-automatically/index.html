<!DOCTYPE html>
<html lang="en-US">
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,700,300' rel='stylesheet' type='text/css'>

	<title>Rebuilding a demo site automatically</title>
	<meta name="description" content="Recently I have been working on the demo server that will house our various demo sites.">

	<link rel="stylesheet" href="/css/main.css">
	<link rel="canonical" href="http://derjoachim.nl/blog/2011/02/rebuilding-demo-site-automatically/">
	<link rel="alternate" type="application/rss+xml" title="Der Joachim" href="http://derjoachim.nl/feed.xml" />
	<script type="text/javascript">
		/*
		var _gaq = _gaq || [];
 	 	 _gaq.push(['_setAccount', 'UA-22946638-1']);
			_gaq.push(['_trackPageview']);

			(function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();
			*/
	</script>
</head>

	<body>
		<header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="/">Der Joachim</a>
    <nav class="site-nav">
      <div class="trigger">
          
          <a class="page-link" href="/blog/2011/02/rebuilding-demo-site-automatically/">Rebuilding a demo site automatically</a>
          
      </div>
    </nav>
  </div>
</header>

		<div class="post">

  <header class="post-header">
    <h1 class="post-title">Rebuilding a demo site automatically</h1>
    <p class="post-meta">Feb 8, 2011 • Shayne</p>
  </header>

  <article class="post-content">
    <p>Recently I have been working on the demo server that will house our various demo sites.</p>

<p>One of the common issues with a demo site is that to preserve its integrity you may need to either restrict access or have a periodic rebuild. Restricting access may work sometimes but it&#8217;s likely to inhibit people trying out anything that is administrative in nature. Hence rebuilding the site is a far more appealing alternative.</p>

<p>The idea is basically delete everything and replace with a fresh copy, but to do so with minimum downtime. The result should be  a quick and secure rebuild. With that in mind we set about creating bash script that would rebuild the site as often as required (run as a cron job).</p>

<p>To get started I mapped out the process.</p>

<p><a href="http://www.flickr.com/photos/nooku/5415925562/" title="Site rebuilt workflow by Nooku, on Flickr"><img src="http://farm5.static.flickr.com/4145/5415925562_26ff253fa1.jpg" width="376" height="500" alt="Site rebuilt workflow" /></a></p>

<p>As you can see we do everything using version control which in this case happened to be <a href="http://en.wikipedia.org/wiki/Apache_Subversion">subversion</a>.</p>

<p>By updating then exporting into a temp folder, the longest part of the process is done prior to any impact on the site. I threw in the checkout logic so that the same script could be used to build a brand new site (as in, one that does not already exist).</p>

<p>The first impact on the public site is the dropping of the database unless there have been changes to the repository that required database modifications.</p>

<p>For a typical site the whole process takes 13 seconds when no changes have been committed to subversion, with less than 2 seconds of downtime.</p>

<!--more-->


<h3>Let&#8217;s speak code</h3>

<p>For those that might find such a script useful, here it is:</p>

<pre class="brush:bash">#! /bin/bash
# A script to build and rebuild a demo site from a svn repository
# -------------------------------------------------------------------------
# Copyright (c) 2010 - 2011 Timble CVBA &lt;http://www.timble.net&gt;
# This script is licensed under GNU GPL version 3.0
# -------------------------------------------------------------------------

# Setup Paramaters
ROOTPATH=/path/to/site
SVNUSER="svn_username"
SVNPASS="svn_password"
SVNURL="https://some.sv.url"
DBUSER="database_username"
DBPASS='database_password'
DB="database_name"
DBSCRIPT=relative/path/to/sql
LOG=/path/to/rebuild.log

# -------------------------------------------------------------------------
# DO NOT CHANGE ANYTHING BELOW UNLESS YOU REALLY KNOW WHAT YOU'RE DOING
# -------------------------------------------------------------------------

START=$(date +%s)

echo " " &gt;&gt; $ROOTPATH/scripts/rebuild.log
echo "Rebuild Started at `date`" &gt;&gt; $LOG

# Checkout the site if its not already there
if [ !  -d $ROOTPATH/svn ]
 then
 echo "Creating svn folder" &gt;&gt; $LOG
 mkdir $ROOTPATH/svn &gt;&gt; $LOG
 echo "Checking out working copy" &gt;&gt; $LOG
 svn co --username $SVNUSER --password $SVNPASS --non-interactive --no-auth-cache $SVNURL $ROOTPATH/svn &gt;&gt; $LOG
fi

# Update SVN (Currently from trunk but a tag might be better)
echo "- Update the working copy" &gt;&gt; $LOG
svn update --username $SVNUSER --password $SVNPASS --non-interactive --no-auth-cache $ROOTPATH/svn &gt;&gt; $LOG

# Export filebase
echo "- Export to public_tmp"  &gt;&gt; $LOG
svn export $ROOTPATH/svn $ROOTPATH/public_tmp &gt;&gt; $LOG

# Delete the current public folder
echo "- Delete the current public folder" &gt;&gt; $LOG
rm -fr $ROOTPATH/public &gt;&gt; $LOG

# Rename the checkout folder to public making it live
echo "- Rename public_tmp to public" &gt;&gt; $LOG
mv $ROOTPATH/public_tmp $ROOTPATH/public &gt;&gt; $LOG

# Set permissions on new public folder
echo "- Set permissions to public folder" &gt;&gt; $LOG
chown -Rf www-data:www-data $ROOTPATH/public &gt;&gt; $LOG
find $ROOTPATH/public -type f -exec chmod 644 {} \; &gt;&gt; $LOG
find $ROOTPATH/public -type d -exec chmod 755 {} \; &gt;&gt; $LOG

# Drop the db
echo "- Drop the database" &gt;&gt; $LOG
mysqladmin -u $DBUSER --password=$DBPASS --force DROP $DB &lt; $ROOTPATH/$DBSCRIPT &gt;&gt; $LOG

# Create the db
echo "- Create the database" &gt;&gt; $ROOTPATH/scripts/rebuild.log
mysqladmin -u $DBUSER --password=$DBPASS CREATE $DB &lt; $ROOTPATH/$DBSCRIPT &gt;&gt; $LOG

# Reload the sql
echo "- Recreate the database" &gt;&gt; $LOG
mysql -u $DBUSER --password=$DBPASS $DB &lt; $ROOTPATH/$DBSCRIPT &gt;&gt; $LOG

# Delete th sql script
echo "- Remove the SQL script" &gt;&gt; $LOG
rm -rf $ROOTPATH/$DBSCRIPT &gt;&gt; $LOG

END=$(date +%s)
DIFF=$(( $END - $START ))
echo "Rebuild completed in $DIFF seconds" &gt;&gt; $LOG
echo " " &gt;&gt; $LOG</pre>


<p>Before running the script you need to configure the parameters. Once that&#8217;s done you can run the script from command line using:</p>

<pre class="brush:bash">sh rebuild.sh</pre>


<h3>Logging, always nice-to-have</h3>

<p>Initially, just to debug, I added very rudimentary logging. But I then got carried away and decided to leave it there. Viewing the log you will see what has been happening. Log file will have entries similar to this:</p>

<pre class="brush:bash">Rebuild Started at Fri Feb  4 08:40:27 UTC 2011
- Update the working copy
At revision 71.
- Export to public_tmp
Export complete.
- Delete the current public folder
- Rename public_tmp to public
- Set permissions to public folder
- Drop the database
Database "demo_database" dropped
- Create the database
- Recreate the database
- Remove the SQL script
Rebuild completed in 13 seconds</pre>


<p>Note that this file will get bigger each time the script is run so especially if you’re going to use a cron job either remove the logging or periodically delete the log file.</p>

<h3>Let&#8217;s automate the script</h3>

<p>Lastly create a cron job to run the script and your rebuild is fully automated. Start by invoking Crontab editor with:</p>

<pre class="brush:bash">crontab -e</pre>


<p>You may be prompted to select an editor. You can then set the time and the path to the script. For example to run an hourly script on the hour you would add:</p>

<pre class="brush:bash">0 * * * * /path/to/rebuild.sh</pre>


<p>Save and your done. Your rebuild script should run every hour on the hour. Check if it is running by viewing the log.</p>

<p>That&#8217;s it, you now have an automatically rebuilt site. Enjoy!</p>

  </article>

</div>

		<footer class="site-footer">

</footer>

	</body>
</html>
